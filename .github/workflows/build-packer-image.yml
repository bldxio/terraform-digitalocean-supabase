name: Build Packer Image with HCP Packer

on:
  push:
    branches:
      - dev
      - main
    paths:
      - "packer/**"

jobs:
  build:
    name: Build Supabase Packer Image with HCP
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Packer
        uses: hashicorp/setup-packer@main
        with:
          version: "1.9.4" # Use a specific version or 'latest'

      - name: Initialize Packer
        working-directory: ./packer
        run: packer init .

      - name: Build and publish image with HCP Packer
        working-directory: ./packer
        env:
          PACKER_LOG: 1
          TF_VAR_do_token: ${{ secrets.DO_API_TOKEN }}
          TF_VAR_region: ${{ vars.DO_REGION }}
          TF_VAR_droplet_image: ${{ vars.DO_DROPLET_IMAGE }}
          TF_VAR_droplet_size: ${{ vars.DO_DROPLET_SIZE }}
          TF_VAR_hcp_bucket_name: ${{ vars.HCP_BUCKET_NAME }}
          TF_VAR_hcp_client_id: ${{ secrets.HCP_CLIENT_ID }}
          TF_VAR_hcp_client_secret: ${{ secrets.HCP_CLIENT_SECRET }}
          TF_VAR_github_actor: ${{ github.actor }}
          TF_VAR_environment: ${{ vars.DEPLOY_ENV }}
        run: packer build .

      - name: Display HCP Packer build information
        run: |
          echo "Build complete. Image has been published to HCP Packer."
          echo "Bucket: ${{ vars.HCP_BUCKET_NAME }}"
